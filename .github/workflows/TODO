# SPDX-FileCopyrightText: 2023 Molokov Klim
# SPDX-License-Identifier: MIT
#
# DONT READ THIS, GO AND DO SOMETHING ELSE

# Запуск эмулятора
echo "Starting Android Emulator..."
$ANDROID_SDK_ROOT/emulator/emulator -avd test_avd \
    -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -snapshot save &

# Ждём, пока эмулятор полностью загрузится
echo "Waiting for emulator to boot..."
adb wait-for-device
adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
echo "✅ Emulator booted"

# Запуск Appium
echo "Starting Appium server..."
appium server -p 4723 -a 0.0.0.0 -pa /wd/hub --relaxed-security > /appium.log 2>&1 &
sleep 10
if curl -s http://127.0.0.1:4723/wd/hub/status > /dev/null; then
    echo "✅ Appium server is running"
else
    echo "❌ Appium failed to start"
    cat /appium.log
    exit 1
fi

# Оставляем контейнер "живым", чтобы в него можно было заходить и запускать тесты
tail -f /dev/null
